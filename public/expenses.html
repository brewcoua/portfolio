<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trip Expense Calculator</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
        }
        .section h2 {
            color: #34495e;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 14px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #3498db;
            color: white;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .amount {
            text-align: right;
            font-weight: bold;
        }
        .positive {
            color: #27ae60;
        }
        .negative {
            color: #e74c3c;
        }
        .total-row {
            background-color: #ecf0f1 !important;
            font-weight: bold;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .summary-card {
            background: #3498db;
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .summary-card h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
        }
        .summary-card .value {
            font-size: 24px;
            font-weight: bold;
        }
        .note {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .export-btn {
            background-color: #27ae60;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        .export-btn:hover {
            background-color: #219a52;
        }
        .tooltip {
            position: relative;
            cursor: help;
            color: #3498db;
            text-decoration: underline dotted;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 300px;
            background-color: #2c3e50;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -150px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            line-height: 1.4;
        }
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #2c3e50 transparent transparent transparent;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .accordion {
            background-color: #f8f9fa;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 5px 10px;
            width: 100%;
            text-align: left;
            border-radius: 4px;
            margin-top: 5px;
            transition: background-color 0.3s;
        }
        .accordion:hover {
            background-color: #e9ecef;
        }
        .accordion.active {
            background-color: #dee2e6;
        }
        .accordion:after {
            content: '\002B';
            font-weight: bold;
            float: right;
            margin-left: 5px;
        }
        .accordion.active:after {
            content: "\2212";
        }
        .panel {
            padding: 0 15px;
            background-color: #f1f3f4;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s ease-out;
            border-radius: 0 0 4px 4px;
        }
        .panel.active {
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        .breakdown-item {
            margin: 5px 0;
            padding: 5px;
            background: white;
            border-radius: 3px;
            border-left: 3px solid #3498db;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèñÔ∏è Trip Expense Calculator</h1>
        
        <div class="summary-grid">
            <div class="summary-card">
                <h3>Total Expenses</h3>
                <div class="value" id="totalExpenses">‚Ç©0</div>
            </div>
            <div class="summary-card">
                <h3>Per Person Average</h3>
                <div class="value" id="avgPerPerson">‚Ç©0</div>
            </div>
            <div class="summary-card">
                <h3>Number of People</h3>
                <div class="value">16</div>
            </div>
        </div>

        <div class="section">
            <h2>üìã Expense Breakdown</h2>
            <table id="expenseTable">
                <thead>
                    <tr>
                        <th>Expense</th>
                        <th>Amount (KRW)</th>
                        <th>Paid By</th>
                        <th>Split Among</th>
                        <th>Per Person</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody id="expenseBody">
                </tbody>
            </table>
        </div>

        <div class="section">
            <h2>üí∞ Individual Balances</h2>
            <div class="note">
                <strong>How to read:</strong> Positive amounts (green) = You should receive money | Negative amounts (red) = You owe money
            </div>
            <table id="balanceTable">
                <thead>
                    <tr>
                        <th>Person</th>
                        <th>Total Paid</th>
                        <th>Share of Expenses</th>
                        <th>Balance</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="balanceBody">
                </tbody>
            </table>
        </div>

        <div class="section">
            <h2>üîÑ Settlement Suggestions</h2>
            <div id="settlementSuggestions"></div>
        </div>

        <button class="export-btn" onclick="exportToCSV()">üìä Export to CSV</button>
    </div>

    <script>
        const people = ['Brewen', 'Matiss', 'Stijn', 'Aurelia', 'Daniel', 'Ismail', 'Jisoo', 'John', 'Kai', 'Karl', 'Mark', 'Michael', 'Muhammad', 'Ravi', 'Yana', 'Kim'];
        
        const expenses = [
            {name: 'Gas Michael (Thu)', amount: 60000, paidBy: 'Michael', splitAmong: people.filter(p => p !== 'Karl'), notes: 'Karl excluded from car expenses', breakdown: []},
            {name: 'Gas Jisoo (Thu)', amount: 30000, paidBy: 'Jisoo', splitAmong: people.filter(p => p !== 'Karl'), notes: 'Karl excluded from car expenses', breakdown: []},
            {name: 'Emart Groceries (Thu)', amount: 227510, paidBy: 'Brewen', splitAmong: people, notes: 'General groceries + alcohol + Jack Daniel', breakdown: [
                {item: 'General groceries', amount: 131870, splitAmong: people},
                {item: 'Jack Daniel (for Karl)', amount: 24800, splitAmong: ['Karl']},
                {item: 'Malibu', amount: 25800, splitAmong: people.filter(p => p !== 'Muhammad' && p !== 'Ismail')},
                {item: 'Terra Beer (BOX, 1.6L √ó 6)', amount: 69840, splitAmong: people.filter(p => p !== 'Muhammad' && p !== 'Ismail')}
            ]},
            {name: 'Charcoal', amount: 23000, paidBy: 'Brewen', splitAmong: people, notes: 'BBQ charcoal', breakdown: []},
            {name: 'Gas Jisoo (Fri)', amount: 42429, paidBy: 'Jisoo', splitAmong: people.filter(p => p !== 'Karl'), notes: 'Karl excluded from car expenses', breakdown: []},
            {name: 'Groceries', amount: 160000, paidBy: 'John', splitAmong: people, notes: 'General groceries', breakdown: []},
            {name: 'Seoraksan Parking', amount: 6000, paidBy: 'Jisoo', splitAmong: ['Brewen', 'Jisoo', 'Ismail'], notes: 'Only for those who went to Seoraksan', breakdown: []},
            {name: 'Gas Michael (Sat)', amount: 60000, paidBy: 'Michael', splitAmong: people.filter(p => p !== 'Karl'), notes: 'Karl excluded from car expenses', breakdown: []},
            {name: 'Groceries (Sat)', amount: 111970, paidBy: 'Brewen', splitAmong: people, notes: 'General groceries', breakdown: []},
            {name: 'Speed Boat', amount: 70000, paidBy: 'Jisoo', splitAmong: ['Jisoo', 'Matiss', 'Brewen', 'Aurelia', 'Ravi', 'Kai', 'Yana', 'Kim', 'John', 'Daniel'], notes: 'Only for speed boat participants', breakdown: []},
            {name: 'Rent Extension (Jisoo)', amount: 28000, paidBy: 'Jisoo', splitAmong: people.filter(p => p !== 'Karl'), notes: 'Car rental extension - Karl excluded', breakdown: []},
            {name: 'Rent Extension (Michael)', amount: 14000, paidBy: 'Michael', splitAmong: people.filter(p => p !== 'Karl'), notes: 'Car rental extension - Karl excluded', breakdown: []},
            {name: 'Groceries (Aurelia)', amount: 61450, paidBy: 'Aurelia', splitAmong: people, notes: 'Mixed groceries including pork', breakdown: [
                {item: 'General groceries', amount: 22750, splitAmong: people},
                {item: 'Pork items', amount: 38700, splitAmong: people.filter(p => p !== 'Muhammad' && p !== 'Ismail')}
            ]},
            {name: 'Pocket Contribution (Brewen)', amount: -20000, paidBy: 'Brewen', splitAmong: people, notes: 'Money added to shared pocket', breakdown: []},
            {name: 'Pocket Usage (Emart)', amount: 30000, paidBy: 'SharedPocket', splitAmong: people, notes: 'Used 18.65‚Ç¨ from pocket for Brewen Emart groceries', breakdown: []},
            {name: 'Pocket Contribution (Michael)', amount: -20000, paidBy: 'Michael', splitAmong: people, notes: 'Money added to shared pocket (unused)', breakdown: []},
            {name: 'Toll (Michael)', amount: 35000, paidBy: 'Michael', splitAmong: people.filter(p => p !== 'Karl'), notes: 'Karl excluded from car expenses', breakdown: []},
            {name: 'Toll (Jisoo)', amount: 30000, paidBy: 'Jisoo', splitAmong: people.filter(p => p !== 'Karl'), notes: 'Karl excluded from car expenses', breakdown: []},
            {name: 'Toll (Ravi)', amount: 30000, paidBy: 'Ravi', splitAmong: people.filter(p => p !== 'Karl'), notes: 'Karl excluded from car expenses', breakdown: []},
            {name: 'Gas Ravi', amount: 60000, paidBy: 'Ravi', splitAmong: people.filter(p => p !== 'Karl'), notes: 'Karl excluded from car expenses', breakdown: []},
            {name: 'Breakfast Kai', amount: 139270, paidBy: 'Kai', splitAmong: people, notes: 'Group breakfast', breakdown: []},
            {name: 'Salad Kai', amount: 53040, paidBy: 'Kai', splitAmong: people, notes: 'Group salad', breakdown: []}
        ];

        // Special adjustments - removed since we're handling them in breakdown
        const specialAdjustments = {};

        function calculateExpenses() {
            const balances = {};
            people.forEach(person => {
                balances[person] = {
                    paid: 0,
                    owes: 0,
                    balance: 0
                };
            });

            let totalExpenses = 0;
            const expenseRows = [];
                
            expenses.forEach(expense => {
                totalExpenses += expense.amount;
                
                // Add to paid amount (skip for pocket transactions)
                if (expense.paidBy !== 'SharedPocket' && expense.amount > 0) {
                    balances[expense.paidBy].paid += expense.amount;
                }
                
                // Handle breakdown if exists
                let perPersonBreakdown = [];
                if (expense.breakdown && expense.breakdown.length > 0) {
                    expense.breakdown.forEach(breakdownItem => {
                        const perPerson = Math.round(breakdownItem.amount / breakdownItem.splitAmong.length);
                        breakdownItem.splitAmong.forEach(person => {
                            balances[person].owes += perPerson;
                        });
                        perPersonBreakdown.push({
                            item: breakdownItem.item,
                            perPerson: perPerson,
                            participants: breakdownItem.splitAmong.length
                        });
                    });
                } else {
                    // Simple split
                    const perPerson = Math.round(expense.amount / expense.splitAmong.length);
                    
                    // Handle pocket transactions differently
                    if (expense.paidBy === 'SharedPocket') {
                        // Pocket usage - everyone benefits equally, no one actually "paid"
                        expense.splitAmong.forEach(person => {
                            balances[person].owes += perPerson; // Everyone owes their share
                        });
                        // Reduce Brewen's total paid since pocket money was used for his groceries
                        balances['Brewen'].paid -= expense.amount;
                    } else if (expense.amount < 0) {
                        // Pocket contribution - person contributed, everyone benefits
                        balances[expense.paidBy].paid += Math.abs(expense.amount); // Person paid into pocket
                        expense.splitAmong.forEach(person => {
                            balances[person].owes -= Math.abs(perPerson); // Reduce everyone's debt
                        });
                    } else {
                        // Regular expense
                        expense.splitAmong.forEach(person => {
                            balances[person].owes += perPerson;
                        });
                    }
                }

                // Calculate display info for per person column
                let displayPerPerson;
                let perPersonTooltip = '';
                
                if (expense.breakdown && expense.breakdown.length > 0) {
                    // For breakdown expenses, show "Varies" with tooltip
                    displayPerPerson = "Varies";
                    perPersonTooltip = perPersonBreakdown.map(item => 
                        `${item.item}: ‚Ç©${item.perPerson.toLocaleString()} (${item.participants} people)`
                    ).join('\n');
                } else if (expense.amount < 0) {
                    // Pocket contribution
                    displayPerPerson = `‚Ç©${Math.abs(Math.round(expense.amount / expense.splitAmong.length)).toLocaleString()} credit`;
                    perPersonTooltip = 'Money contributed to shared pocket - reduces everyone\'s share';
                } else if (expense.paidBy === 'SharedPocket') {
                    // Pocket usage
                    displayPerPerson = `‚Ç©${Math.round(expense.amount / expense.splitAmong.length).toLocaleString()} from pocket`;
                    perPersonTooltip = 'Paid from shared pocket money';
                } else {
                    // For simple expenses, show the actual per person amount
                    displayPerPerson = Math.round(expense.amount / expense.splitAmong.length);
                    if (expense.splitAmong.length !== people.length) {
                        perPersonTooltip = `Split among ${expense.splitAmong.length} people only`;
                    }
                }

                expenseRows.push({
                    ...expense,
                    displayPerPerson: displayPerPerson,
                    perPersonTooltip: perPersonTooltip,
                    splitAmongStr: expense.splitAmong.length === people.length ? 'Everyone' : `${expense.splitAmong.length} people`
                });
            });

            // Apply special adjustments (kept for any remaining edge cases)
            Object.keys(specialAdjustments).forEach(person => {
                Object.keys(specialAdjustments[person]).forEach(adjustment => {
                    const amount = specialAdjustments[person][adjustment];
                    balances[person].owes += amount;
                });
            });

            // Calculate final balances
            people.forEach(person => {
                balances[person].balance = balances[person].paid - balances[person].owes;
            });

            return { balances, totalExpenses, expenseRows };
        }

        function formatCurrency(amount) {
            return '‚Ç©' + amount.toLocaleString();
        }

        function createTooltip(people, excludedContext = '') {
            const tooltip = `
                <div class="tooltip">
                    ${people.length} people
                    <span class="tooltiptext">
                        <strong>Split among:</strong><br>
                        ${people.join(', ')}
                        ${excludedContext ? `<br><br><strong>Excluded:</strong><br>${excludedContext}` : ''}
                    </span>
                </div>
            `;
            return tooltip;
        }

        function createBreakdownAccordion(expense, index) {
            if (!expense.breakdown || expense.breakdown.length === 0) {
                return '';
            }

            let breakdownHtml = `
                <button class="accordion" onclick="toggleAccordion(${index})">
                    Show Breakdown
                </button>
                <div class="panel" id="panel-${index}">
            `;

            expense.breakdown.forEach(item => {
                const perPerson = Math.round(item.amount / item.splitAmong.length);
                const excludedPeople = people.filter(p => !item.splitAmong.includes(p));
                const excludedText = excludedPeople.length > 0 ? excludedPeople.join(', ') : '';
                
                breakdownHtml += `
                    <div class="breakdown-item">
                        <strong>${item.item}:</strong> ${formatCurrency(item.amount)}<br>
                        <small>Split among: ${item.splitAmong.join(', ')} (${formatCurrency(perPerson)} each)</small>
                        ${excludedText ? `<br><small style="color: #e74c3c;">Excluded: ${excludedText}</small>` : ''}
                    </div>
                `;
            });

            breakdownHtml += '</div>';
            return breakdownHtml;
        }

        function renderExpenseTable(expenseRows) {
            const tbody = document.getElementById('expenseBody');
            tbody.innerHTML = '';
            
            expenseRows.forEach((expense, index) => {
                const row = tbody.insertRow();
                
                // Get excluded people for tooltip
                const excludedPeople = people.filter(p => !expense.splitAmong.includes(p));
                const excludedText = excludedPeople.length > 0 ? excludedPeople.join(', ') : '';
                
                const splitTooltip = createTooltip(expense.splitAmong, excludedText);
                const breakdownAccordion = createBreakdownAccordion(expense, index);
                
                // Create per person display with tooltip if needed
                let perPersonDisplay;
                if (typeof expense.displayPerPerson === 'string') {
                    // "Varies" case with tooltip
                    perPersonDisplay = `
                        <div class="tooltip">
                            ${expense.displayPerPerson}
                            <span class="tooltiptext" style="white-space: pre-line;">
                                ${expense.perPersonTooltip}
                            </span>
                        </div>
                    `;
                } else {
                    // Regular amount with optional tooltip for partial splits
                    if (expense.perPersonTooltip) {
                        perPersonDisplay = `
                            <div class="tooltip">
                                ${formatCurrency(expense.displayPerPerson)}
                                <span class="tooltiptext">
                                    ${expense.perPersonTooltip}
                                </span>
                            </div>
                        `;
                    } else {
                        perPersonDisplay = formatCurrency(expense.displayPerPerson);
                    }
                }
                
                row.innerHTML = `
                    <td>
                        ${expense.name}
                        ${breakdownAccordion}
                    </td>
                    <td class="amount">${formatCurrency(expense.amount)}</td>
                    <td>${expense.paidBy}</td>
                    <td>${splitTooltip}</td>
                    <td class="amount">${perPersonDisplay}</td>
                    <td>${expense.notes}</td>
                `;
            });
        }

        function renderBalanceTable(balances) {
            const tbody = document.getElementById('balanceBody');
            tbody.innerHTML = '';
            
            people.forEach(person => {
                const balance = balances[person];
                const row = tbody.insertRow();
                const balanceClass = balance.balance > 0 ? 'positive' : balance.balance < 0 ? 'negative' : '';
                const status = balance.balance > 0 ? 'Should receive' : balance.balance < 0 ? 'Owes money' : 'Even';
                
                row.innerHTML = `
                    <td>${person}</td>
                    <td class="amount">${formatCurrency(balance.paid)}</td>
                    <td class="amount">${formatCurrency(balance.owes)}</td>
                    <td class="amount ${balanceClass}">${formatCurrency(balance.balance)}</td>
                    <td class="${balanceClass}">${status}</td>
                `;
            });
        }

        function generateSettlementSuggestions(balances) {
            const creditors = [];
            const debtors = [];
            
            people.forEach(person => {
                const balance = balances[person].balance;
                if (balance > 100) { // Small threshold to avoid tiny amounts
                    creditors.push({name: person, amount: balance});
                } else if (balance < -100) {
                    debtors.push({name: person, amount: Math.abs(balance)});
                }
            });

            creditors.sort((a, b) => b.amount - a.amount);
            debtors.sort((a, b) => b.amount - a.amount);

            const suggestions = [];
            let i = 0, j = 0;

            while (i < creditors.length && j < debtors.length) {
                const creditor = creditors[i];
                const debtor = debtors[j];
                const amount = Math.min(creditor.amount, debtor.amount);

                suggestions.push(`${debtor.name} pays ${formatCurrency(amount)} to ${creditor.name}`);

                creditor.amount -= amount;
                debtor.amount -= amount;

                if (creditor.amount <= 0) i++;
                if (debtor.amount <= 0) j++;
            }

            const container = document.getElementById('settlementSuggestions');
            if (suggestions.length === 0) {
                container.innerHTML = '<p>No settlements needed - everyone is even!</p>';
            } else {
                container.innerHTML = '<ul>' + suggestions.map(s => `<li>${s}</li>`).join('') + '</ul>';
            }
        }

        function updateSummary(totalExpenses) {
            document.getElementById('totalExpenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('avgPerPerson').textContent = formatCurrency(Math.round(totalExpenses / people.length));
        }

        function exportToCSV() {
            const { balances, totalExpenses, expenseRows } = calculateExpenses();
            
            let csv = 'Person,Total Paid,Share of Expenses,Balance,Status\n';
            people.forEach(person => {
                const balance = balances[person];
                const status = balance.balance > 0 ? 'Should receive' : balance.balance < 0 ? 'Owes money' : 'Even';
                csv += `${person},${balance.paid},${balance.owes},${balance.balance},${status}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'trip_expenses.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function toggleAccordion(index) {
            const accordion = document.querySelector(`#panel-${index}`).previousElementSibling;
            const panel = document.getElementById(`panel-${index}`);
            
            accordion.classList.toggle('active');
            panel.classList.toggle('active');
        }

        // Initialize the calculator
        function init() {
            const { balances, totalExpenses, expenseRows } = calculateExpenses();
            
            updateSummary(totalExpenses);
            renderExpenseTable(expenseRows);
            renderBalanceTable(balances);
            generateSettlementSuggestions(balances);
        }

        // Run initialization when page loads
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>